<!DOCTYPE html>
<html class="writer-html5" lang="pt-BR" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.1.11. Verificação Topológica das Geometrias das Glebas &mdash; GeoCreditoRural</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/table_styling.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tutorial.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="canonical" href="https://geo-credito-rural.github.io/sicor/microdados/glebas-topologia.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Buscar" href="../../search.html" />
    <link rel="next" title="3.1.12. Avaliação da Forma das Glebas" href="glebas-forma.html" />
    <link rel="prev" title="3.1.10. Glebas de Operações Contratadas com Recursos Públicos" href="glebas.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #F0F8FF" >

          
          
          <a href="../../index.html" class="icon icon-home">
            GeoCreditoRural
              <img src="../../_static/logo.jpeg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Pesquisar documentos" aria-label="Pesquisar documentos" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Menu de navegação">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Monitoramento de Operações de Crédito Rural por meio de Geotecnologias</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Aulas:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">1. Introdução à Linguagem de Consulta SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jupyter/index.html">2. Ambiente de Computação Interativa</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">3. Dados do Sicor</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">3.1. Sicor - Tabelas e Microdados do Crédito Rural e do Proagro</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="preparacao-base-dados.html">3.1.1. Preparação da Base de Dados Sicor</a></li>
<li class="toctree-l3"><a class="reference internal" href="empreendimentos.html">3.1.2. Empreendimentos de Contratos de Crédito Rural</a></li>
<li class="toctree-l3"><a class="reference internal" href="ifs.html">3.1.3. Instituições Financeiras (IFs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="instrumento-credito.html">3.1.4. Instrumento de Crédito</a></li>
<li class="toctree-l3"><a class="reference internal" href="emitente.html">3.1.5. Categoria de Emitente</a></li>
<li class="toctree-l3"><a class="reference internal" href="fontes-recursos.html">3.1.6. Fontes de Recursos</a></li>
<li class="toctree-l3"><a class="reference internal" href="seguro.html">3.1.7. Garantia do Empreendimento</a></li>
<li class="toctree-l3"><a class="reference internal" href="programa.html">3.1.8. Programas ou Linhas de Crédito</a></li>
<li class="toctree-l3"><a class="reference internal" href="operacoes.html">3.1.9. Operações Contratadas com Recursos Públicos e Privados</a></li>
<li class="toctree-l3"><a class="reference internal" href="glebas.html">3.1.10. Glebas de Operações Contratadas com Recursos Públicos</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.1.11. Verificação Topológica das Geometrias das Glebas</a></li>
<li class="toctree-l3"><a class="reference internal" href="glebas-forma.html">3.1.12. Avaliação da Forma das Glebas</a></li>
<li class="toctree-l3"><a class="reference internal" href="pedidos-cobertura-proagro.html">3.1.13. Pedidos de cobertura do Proagro (COP)</a></li>
<li class="toctree-l3"><a class="reference internal" href="mutuarios.html">3.1.14. Mutuários</a></li>
<li class="toctree-l3"><a class="reference internal" href="cooperados.html">3.1.15. Cooperados</a></li>
<li class="toctree-l3"><a class="reference internal" href="propriedades.html">3.1.16. Propriedades</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../zarc-db.html">3.2. Zoneamento Agrícola de Risco Climático (ZARC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analises.html">3.3. Análise da Qualidade dos Dados do Sicor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bases-vetoriais/index.html">4. Impedimentos Sociais, Ambientais e Climáticos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uso-cobertura-terra/index.html">5. Uso e Cobertura da Terra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acesso-imagens/index.html">6. Imagens de Satélites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../series-temporais/index.html">7. Séries Temporais de Imagens de Satélites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fenologia/index.html">8. Fenologia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../padroes-series-temporais/index.html">9. Padrões em Séries Temporais de Imagens de Satélites</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Referências Bibliográficas</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../referencias.html">Referências Bibliográficas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Informações Gerais:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../licenca.html">Licença</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agradecimentos.html">Agradecimentos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Índice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossário</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search.html">Página de Busca</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Menu de navegação móvel"  style="background: #F0F8FF" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GeoCreditoRural</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Navegação da página">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">3. </span>Dados do Sicor</a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">3.1. </span>Sicor - Tabelas e Microdados do Crédito Rural e do Proagro</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3.1.11. </span>Verificação Topológica das Geometrias das Glebas</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul><div class="rst-breadcrumbs-buttons" role="navigation" aria-label="Navegação sequencial da página">
        <a href="glebas.html" class="btn btn-neutral float-left" title="3.1.10. Glebas de Operações Contratadas com Recursos Públicos" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="glebas-forma.html" class="btn btn-neutral float-right" title="3.1.12. Avaliação da Forma das Glebas" accesskey="n">Próximo <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="verificacao-topologica-das-geometrias-das-glebas">
<span id="sec-sicor-microdados-glebas-topologia"></span><h1><span class="section-number">3.1.11. </span>Verificação Topológica das Geometrias das Glebas<a class="headerlink" href="#verificacao-topologica-das-geometrias-das-glebas" title="Link permanente para este cabeçalho"></a></h1>
<p>Para facilitar as análises dessa seção, iremos criar uma tabela denominada <code class="docutils literal notranslate"><span class="pre">sicor_glebas</span></code> a partir da tabela <code class="docutils literal notranslate"><span class="pre">sicor_glebas_wkt</span></code>, substituindo a coluna <code class="docutils literal notranslate"><span class="pre">gt_geometria</span></code> do tipo <code class="docutils literal notranslate"><span class="pre">text</span></code> por uma coluna denominada <code class="docutils literal notranslate"><span class="pre">geom</span></code> do tipo <code class="docutils literal notranslate"><span class="pre">geometry</span></code> com as geometrias em 2D e associadas ao SRS EPSG:4674. Além disso, iremos incluir uma coluna com o ano da data de emissão da operação associada à gleba. A <a class="reference internal" href="#fig-sicor-microdados-er-sicor-glebas"><span class="std std-numref">Figura 3.10</span></a> apresenta a estrutura e relacionamento dessa tabela com a tabela de operações contratadas.</p>
<figure class="align-center align-default" id="fig-sicor-microdados-er-sicor-glebas">
<a class="reference internal image-reference" href="../../_images/er-sicor-glebas.png"><img alt="Tabela com coluna geométrica para tratamento das glebas" src="../../_images/er-sicor-glebas.png" style="width: 60%;" /></a>
<figcaption>
<p><span class="caption-number">Figura 3.10 - </span><span class="caption-text">Tabela com coluna geométrica para tratamento das glebas.</span><a class="headerlink" href="#fig-sicor-microdados-er-sicor-glebas" title="Link Permanente para essa imagem"></a></p>
</figcaption>
</figure>
<p>O comando apresentado no <a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-create-sicor-glebas"><span class="std std-numref">Techo de Código 3.12</span></a> mostra como podemos criar essa tabela.</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-create-sicor-glebas">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.12 - </span><span class="caption-text">Criação da tabela de glebas com coluna geométrica.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-create-sicor-glebas" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="w"> </span><span class="k">AS</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">ROW_NUMBER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span>
<span class="w">           </span><span class="n">glebas</span><span class="p">.</span><span class="n">ref_bacen</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ref_bacen</span><span class="p">,</span>
<span class="w">           </span><span class="n">glebas</span><span class="p">.</span><span class="n">nu_ordem</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nu_ordem</span><span class="p">,</span>
<span class="w">           </span><span class="n">glebas</span><span class="p">.</span><span class="n">nu_indice</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">nu_indice</span><span class="p">,</span>
<span class="w">           </span><span class="n">contratos</span><span class="p">.</span><span class="n">dt_emissao</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">data_emissao_contrato</span><span class="p">,</span>
<span class="w">           </span><span class="p">(</span><span class="n">ST_Force2D</span><span class="p">(</span><span class="n">GT_GEOMETRIA</span><span class="p">::</span><span class="n">geometry</span><span class="p">))::</span><span class="n">geometry</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="mi">4674</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">sicor_glebas_wkt</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">glebas</span><span class="p">,</span>
<span class="w">         </span><span class="n">sicor_operacao_basica_estado</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">contratos</span>
<span class="w">   </span><span class="k">WHERE</span><span class="w"> </span><span class="n">glebas</span><span class="p">.</span><span class="n">ref_bacen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contratos</span><span class="p">.</span><span class="n">ref_bacen</span>
<span class="w">     </span><span class="k">AND</span><span class="w"> </span><span class="n">glebas</span><span class="p">.</span><span class="n">nu_ordem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contratos</span><span class="p">.</span><span class="n">nu_ordem</span><span class="p">;</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">sicor_glebas_pkey</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">gid</span><span class="p">);</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">sicor_glebas_ukey</span><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">ref_bacen</span><span class="p">,</span><span class="w"> </span><span class="n">nu_ordem</span><span class="p">,</span><span class="w"> </span><span class="n">nu_indice</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">sicor_glebas_geom_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GiST</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">sicor_glebas_data_emissao_contrato_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="p">(</span><span class="n">data_emissao_contrato</span><span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">sicor_glebas_ano_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="p">(</span><span class="k">extract</span><span class="p">(</span><span class="k">YEAR</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">data_emissao_contrato</span><span class="p">));</span>

<span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">sicor_glebas_ref_bacen_fkey</span>
<span class="w">    </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">ref_bacen</span><span class="p">,</span><span class="w"> </span><span class="n">nu_ordem</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">sicor_operacao_basica_estado</span><span class="p">(</span><span class="n">ref_bacen</span><span class="p">,</span><span class="w"> </span><span class="n">nu_ordem</span><span class="p">)</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">CASCADE</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="n">ACTION</span><span class="p">;</span>
</pre></div>
</div>
</div>
<section id="verificacao-das-geometrias">
<h2><span class="section-number">3.1.11.1. </span>Verificação das Geometrias<a class="headerlink" href="#verificacao-das-geometrias" title="Link permanente para este cabeçalho"></a></h2>
<p>A partir da tabela <code class="docutils literal notranslate"><span class="pre">sicor_glebas</span></code> podemos avaliar a existência de glebas com geometrias inválidas com o uso da função <code class="docutils literal notranslate"><span class="pre">ST_IsValid</span></code> (<a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-glebas-geom-invalidas"><span class="std std-numref">Trecho de Código 3.13</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-glebas-geom-invalidas">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.13 - </span><span class="caption-text">Glebas com geometrias inválidas.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-glebas-geom-invalidas" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">ref_bacen</span><span class="p">,</span><span class="w"> </span><span class="n">nu_ordem</span><span class="p">,</span><span class="w"> </span><span class="n">nu_indice</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">sicor_glebas</span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>O resultado mostrado abaixo indica que apenas 26 glebas possuem algum tipo de problema geométrico.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>NOTICE:  Ring Self-intersection at or near point 54.103099999999998 25.316500000000001
NOTICE:  Ring Self-intersection at or near point -52.146380999999998 -24.662628000000002
NOTICE:  Ring Self-intersection at or near point -47.544922 -10.505932
NOTICE:  Ring Self-intersection at or near point -47.544922 -10.505932
NOTICE:  Ring Self-intersection at or near point -52.208253999999997 -24.083690000000001
NOTICE:  Ring Self-intersection at or near point -58.145878000000003 -15.524556
NOTICE:  Ring Self-intersection at or near point -51.721031000000004 -24.555568999999998
NOTICE:  Ring Self-intersection at or near point -52.386659999999999 -23.821411999999999
NOTICE:  Ring Self-intersection at or near point -61.003579000000002 2.3315399999999999
NOTICE:  Ring Self-intersection at or near point -52.292940000000002 -24.661868999999999
NOTICE:  Ring Self-intersection at or near point -52.356896999999996 -23.897447
NOTICE:  Ring Self-intersection at or near point -49.801737000000003 -9.6472180000000005
NOTICE:  Ring Self-intersection at or near point -52.194122 -24.697422
NOTICE:  Ring Self-intersection at or near point -53.847330999999997 -24.514718999999999
NOTICE:  Ring Self-intersection at or near point -52.292940000000002 -24.661868999999999
NOTICE:  Ring Self-intersection at or near point -52.352621999999997 -24.160169
NOTICE:  Ring Self-intersection at or near point -51.548752 0.60170199999999996
NOTICE:  Ring Self-intersection at or near point -52.133678000000003 -26.484113000000001
NOTICE:  Ring Self-intersection at or near point -52.738799999999898 -26.415659999999999
NOTICE:  Ring Self-intersection at or near point -40.756017999999997 -20.564651000000001
NOTICE:  Ring Self-intersection at or near point -52.297652999999897 -18.096931000000001
NOTICE:  Ring Self-intersection at or near point -49.637627999999999 -17.583576000000001
NOTICE:  Ring Self-intersection at or near point -51.029156 -23.781583999999999
NOTICE:  Ring Self-intersection at or near point -72.851114409999994 -7.8101053800000004
NOTICE:  Ring Self-intersection at or near point -65.229758230000002 -10.68783363
NOTICE:  Ring Self-intersection at or near point -54.85163923695 -28.178468158379999
   gid   | ref_bacen | nu_ordem | nu_indice
---------+-----------+----------+-----------
   87692 |   9224227 |        1 |         0
   87693 |   9224227 |        1 |         1
  180299 |   9943482 |        1 |         0
  271077 | 505196858 |        1 |         2
 1214937 | 508992024 |        1 |         0
 4926682 | 516242663 |        1 |         0
    1642 |   4532422 |        1 |         1
  378736 | 505804666 |        1 |         5
  711850 | 507412386 |        1 |         1
  813733 | 507928354 |        1 |         0
  415927 | 506085211 |        1 |         2
  417413 | 506093980 |        1 |         0
  481085 | 506539153 |        1 |         1
  593815 | 507068452 |        1 |         2
  976638 | 508600719 |        1 |         0
 1179154 | 508931913 |        1 |         0
 3526719 | 513782490 |        1 |         0
   39042 |   8485284 |        1 |         2
  103311 |   9430765 |        1 |         0
  125673 |   9593592 |        1 |         0
  392979 | 505938220 |        1 |         1
  393658 | 505942484 |        1 |         1
  532660 | 506841795 |        1 |         0
 3814156 | 514320193 |        1 |         1
  410497 | 506051104 |        1 |         0
  448769 | 506316575 |        1 |         2
(26 rows)
</pre></div>
</div>
<p>O número de geometrias inválidas em cada ano é muito pequeno, como mostrado no resultado da consulta abaixo (<a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-glebas-geom-validas-e-invalidas"><span class="std std-numref">Trecho de Código 3.14</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-glebas-geom-validas-e-invalidas">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.14 - </span><span class="caption-text">Glebas com geometrias válidas e inválidas em cada ano.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-glebas-geom-validas-e-invalidas" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span><span class="w"> </span><span class="n">glebas_com_geom_invalidas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">YEAR</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">data_emissao_contrato</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano</span><span class="p">,</span>
<span class="w">             </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_geom_invalidas</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">sicor_glebas</span>
<span class="w">       </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ano</span>
<span class="p">),</span>
<span class="n">glebas_com_geom_validas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span>
<span class="w">      </span><span class="k">SELECT</span><span class="w"> </span><span class="k">extract</span><span class="p">(</span><span class="k">YEAR</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">data_emissao_contrato</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano</span><span class="p">,</span>
<span class="w">             </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_geom_validas</span>
<span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">sicor_glebas</span>
<span class="w">       </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
<span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">ano</span>
<span class="p">)</span>
<span class="w">         </span><span class="k">SELECT</span><span class="w"> </span><span class="n">glebas_com_geom_validas</span><span class="p">.</span><span class="n">ano</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ano</span><span class="p">,</span>
<span class="w">                </span><span class="n">glebas_com_geom_validas</span><span class="p">.</span><span class="n">num_geom_validas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_geom_validas</span><span class="p">,</span>
<span class="w">                </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">glebas_com_geom_invalidas</span><span class="p">.</span><span class="n">num_geom_invalidas</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                     </span><span class="k">ELSE</span><span class="w"> </span><span class="n">glebas_com_geom_invalidas</span><span class="p">.</span><span class="n">num_geom_invalidas</span>
<span class="w">                </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_geom_invalidas</span>
<span class="w">           </span><span class="k">FROM</span><span class="w"> </span><span class="n">glebas_com_geom_validas</span>
<span class="k">FULL</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">glebas_com_geom_invalidas</span>
<span class="w">          </span><span class="k">ON</span><span class="w"> </span><span class="n">glebas_com_geom_validas</span><span class="p">.</span><span class="n">ano</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">glebas_com_geom_invalidas</span><span class="p">.</span><span class="n">ano</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Essa consulta irá produzir um resultado semelhante ao mostrado abaixo:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> ano  | num_geom_validas | num_geom_invalidas
------+------------------+--------------------
 2013 |              647 |                  0
 2014 |             1970 |                  1
 2015 |             8949 |                  0
 2016 |            90471 |                  3
 2017 |           315783 |                 10
 2018 |           397647 |                  6
 2019 |           612492 |                  3
 2020 |           892701 |                  0
 2021 |           991164 |                  0
 2022 |          1073780 |                  2
 2023 |          1131585 |                  1
 2024 |           299158 |                  0
(12 rows)
</pre></div>
</div>
<p>Vamos criar uma tabela auxiliar denominada <code class="docutils literal notranslate"><span class="pre">glebas_geom_invalidas</span></code> para estudar os casos de glebas com geometrias inválidas de maneira mais fácil (<a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-tbl-glebas-geom-invalidas"><span class="std std-numref">Trecho de Código 3.15</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-tbl-glebas-geom-invalidas">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.15 - </span><span class="caption-text">Tabela de glebas com geometrias inválidas.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-tbl-glebas-geom-invalidas" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">glebas_geom_invalidas</span><span class="w"> </span><span class="k">AS</span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="w">          </span><span class="k">FROM</span><span class="w"> </span><span class="n">sicor_glebas</span>
<span class="w">         </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>A função <code class="docutils literal notranslate"><span class="pre">ST_IsValidReason</span></code> pode ser usada para determinar a razão da geometria ser considerada inválida. A consulta do <a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-motivo-geom-invalida"><span class="std std-numref">Trecho de Código 3.16</span></a> mostra como usar essa função.</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-motivo-geom-invalida">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.16 - </span><span class="caption-text">Motivo das geometrias das glebas serem consideradas inválidas.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-motivo-geom-invalida" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">ST_IsValidReason</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">motivo</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">glebas_geom_invalidas</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>O resultado dessa consulta aponta que os casos considerados inválidos são ocasionados por anéis com auto-intersecções.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>   gid   |                         motivo
---------+---------------------------------------------------------
  415927 | Ring Self-intersection[-52.194122 -24.697422]
  417413 | Ring Self-intersection[-53.847331 -24.514719]
 1214937 | Ring Self-intersection[-51.029156 -23.781584]
 3526719 | Ring Self-intersection[-72.85111441 -7.81010538]
    1642 | Ring Self-intersection[54.1031 25.3165]
  271077 | Ring Self-intersection[-52.38666 -23.821412]
  410497 | Ring Self-intersection[-49.801737 -9.647218]
  532660 | Ring Self-intersection[-51.548752 0.601702]
  711850 | Ring Self-intersection[-52.7387999999999 -26.41566]
  103311 | Ring Self-intersection[-52.208254 -24.08369]
  378736 | Ring Self-intersection[-61.003579 2.33154]
  481085 | Ring Self-intersection[-52.352622 -24.160169]
  593815 | Ring Self-intersection[-52.133678 -26.484113]
 3814156 | Ring Self-intersection[-65.22975823 -10.68783363]
 4926682 | Ring Self-intersection[-54.85163923695 -28.17846815838]
  125673 | Ring Self-intersection[-58.145878 -15.524556]
  392979 | Ring Self-intersection[-52.29294 -24.661869]
  393658 | Ring Self-intersection[-52.356897 -23.897447]
  813733 | Ring Self-intersection[-40.756018 -20.564651]
 1179154 | Ring Self-intersection[-49.637628 -17.583576]
   39042 | Ring Self-intersection[-52.146381 -24.662628]
   87692 | Ring Self-intersection[-47.544922 -10.505932]
   87693 | Ring Self-intersection[-47.544922 -10.505932]
  180299 | Ring Self-intersection[-51.721031 -24.555569]
  448769 | Ring Self-intersection[-52.29294 -24.661869]
  976638 | Ring Self-intersection[-52.2976529999999 -18.096931]
(26 rows)
</pre></div>
</div>
<p>A <a class="reference internal" href="#fig-sicor-microdados-glebas-topologia-gleba-invalida-gid-39042"><span class="std std-numref">Figura 3.11</span></a> destaca o vértice que apresenta o local da auto-intersecção para a gleba com o identificador (<code class="docutils literal notranslate"><span class="pre">gid</span></code>) 39042.</p>
<figure class="align-center align-default" id="fig-sicor-microdados-glebas-topologia-gleba-invalida-gid-39042">
<a class="reference internal image-reference" href="../../_images/gleba-invalida-gid-39042.png"><img alt="Gleba com geometria inválida" src="../../_images/gleba-invalida-gid-39042.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-number">Figura 3.11 - </span><span class="caption-text">Gleba com geometria inválida.</span><a class="headerlink" href="#fig-sicor-microdados-glebas-topologia-gleba-invalida-gid-39042" title="Link Permanente para essa imagem"></a></p>
</figcaption>
</figure>
<p>A geometria da gleba mostrada acima possui apenas um anel exterior, como mostrado na consulta do <a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-num-rings"><span class="std std-numref">Trecho de Código 3.17</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-num-rings">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.17 - </span><span class="caption-text">Motivo das geometrias das glebas serem consideradas inválidas.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-num-rings" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ST_NRings</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">numero_aneis</span><span class="p">,</span>
<span class="w">       </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">wkt</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">glebas_geom_invalidas</span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">39042</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> numero_aneis |                                           wkt
--------------+------------------------------------------------------------------------------------------------------------
            1 | POLYGON((-52.1472980728205 -24.663044851282,...,-52.146381 -24.662628,-52.1472980728205 -24.663044851282))
(1 row)
</pre></div>
</div>
<p>Esse tipo de problema geométrico pode ser corrigido através da função <code class="docutils literal notranslate"><span class="pre">ST_MakeValid</span></code>. Para ilustrar o uso dessa função, vamos criar uma nova tabela denominada <code class="docutils literal notranslate"><span class="pre">glebas_geom_validas</span></code> a partir da tabela <code class="docutils literal notranslate"><span class="pre">glebas_geom_invalidas</span></code> (<a class="reference internal" href="#code-sicor-microdados-glebas-topologia-sql-tbl-glebas-geom-validas"><span class="std std-numref">Trecho de Código 3.18</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="code-sicor-microdados-glebas-topologia-sql-tbl-glebas-geom-validas">
<div class="code-block-caption"><span class="caption-number">Trecho de Código 3.18 - </span><span class="caption-text">Correção das geometrias inválidas.</span><a class="headerlink" href="#code-sicor-microdados-glebas-topologia-sql-tbl-glebas-geom-validas" title="Link Permanente para esse código"></a></div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">glebas_geom_validas</span><span class="w"> </span><span class="k">AS</span>
<span class="w">                </span><span class="k">SELECT</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">ref_bacen</span><span class="p">,</span><span class="w"> </span><span class="n">nu_ordem</span><span class="p">,</span><span class="w"> </span><span class="n">nu_indice</span><span class="p">,</span><span class="w"> </span><span class="n">data_emissao_contrato</span><span class="p">,</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">geom</span>
<span class="w">                  </span><span class="k">FROM</span><span class="w"> </span><span class="n">glebas_geom_invalidas</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>Analisando o resultado da correção realizada, podemos verificar que no caso da gleba com o identificador (<code class="docutils literal notranslate"><span class="pre">gid</span></code>) 39042, foi criado um anel interno.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ST_NRings</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">numero_aneis</span><span class="p">,</span>
<span class="w">       </span><span class="n">ST_AsText</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">wkt</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">glebas_geom_validas</span>
<span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">39042</span><span class="p">;</span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span> numero_aneis |                               wkt
--------------+----------------------------------------------------------------------------------
            2 | POLYGON((-52.148302 -24.663986,...,-52.146381 -24.662628,-52.148302 -24.663986),
                        (-52.147258 -24.662867,...,-52.146381 -24.662628,-52.147258 -24.662867))
(1 row)
</pre></div>
</div>
<p>Como pode ser observado nas figuras da <a class="reference internal" href="#tbl-sicor-microdados-glebas-topologia-geometria-invalida-x-valida"><span class="std std-numref">Tabela 3.12</span></a>, visualmente a correção realizada pela função <cite>ST_MakeValid`</cite> é imperceptível pois apenas um anel interno foi adicionado.</p>
<table class="styled-table docutils align-center" id="tbl-sicor-microdados-glebas-topologia-geometria-invalida-x-valida" style="width: 100%">
<caption><span class="caption-number">Tabela 3.12 - </span><span class="caption-text">Comparação do antes e depois da correção geométrica.</span><a class="headerlink" href="#tbl-sicor-microdados-glebas-topologia-geometria-invalida-x-valida" title="Link Permanente para essa tabela"></a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td class="center-align"><p><img alt="fig:sicor:microdados:glebas-topologia:gleba-invalida-gid-39042-b" src="../../_images/gleba-invalida-gid-39042.png" /></p></td>
<td class="center-align"><p><img alt="fig:sicor:microdados:glebas-topologia:gleba-valida-gid-39042" src="../../_images/gleba-valida-gid-39042.png" /></p></td>
</tr>
</tbody>
</table>
<p>Para corrigir automaticamente todas as geometrias inválidas da tabela <code class="docutils literal notranslate"><span class="pre">sicor_glebas</span></code>, podemos fazer:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">sicor_glebas</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">geom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ST_MakeValid</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">ST_IsValid</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre></div>
</div>
<p>Resultado:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>UPDATE 26
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Rodapé">
        <a href="glebas.html" class="btn btn-neutral float-left" title="3.1.10. Glebas de Operações Contratadas com Recursos Públicos" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Anterior</a>
        <a href="glebas-forma.html" class="btn btn-neutral float-right" title="3.1.12. Avaliação da Forma das Glebas" accesskey="n" rel="next">Próximo <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Time.</p>
  </div>

  
<jinja2.runtime.BlockReference object at 0x7fbc1f3a4940>
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-nc-sa.png" width="117" height="41"/></a> This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons “Attribution-NonCommercial-ShareAlike 4.0 International” license</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>